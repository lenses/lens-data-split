<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-selector/iron-selector.html">
<link rel="import" href="../iron-input/iron-input.html">
<!--
A Lenses data component to split a column into columns based on a string separator

##### Example

    <lens-data-split></lens-data-split>

@element lens-data-split
@group Lenses data component
@blurb Split data into multiple columns. Splits at the separator, defaults to comma
@status alpha
@homepage http://lenses.github.io/lens-data-split/index.html
-->

<dom-module id="lens-data-split">
  <link rel="import" type="css" href="lens-data-split.css">
  <template>

    <div class="th-container th-data">

        <p class="info">Split a column into multiple based on split character.</p>
        <label class="label" for="func_selector">Filter on column:</label>
        <iron-selector class="selector" id="value_selector" selected="{{splitColumn}}" attr-for-selected="label">
          <template is="dom-repeat" items="{{_dataAttributes}}" as="attr">
            <div class="col" label="{{attr}}">{{attr}}</div>
          </template>
        </iron-selector>
        <label class="label">split by:</label>
        <input is="core-input" value="{{splitChar::input}}">
        <label class="label">New column labels:</label>
        <template is="dom-repeat" items="{{splitColumnNames}}" as="name" index-as="index">
          <input is="core-input" value="{{name::input}}" _index="{{index}}" class="col-name" on-change="_splitNameChanged">
        </template>

    </div>

  </template>
</dom-module>
<script>
  Polymer({
    is: 'lens-data-split',
    properties: {
      _splitName: { observer: '_splitNameChanged' },
      input: {
        notify: true,
        observer: 'inputChanged'
      },
      output: { notify: true },
      splitChar: {
        type: String,
        value: ',',
        notify: true,
        observer: '_calculateOutput'
      },
      splitColumn: {
        type: Array,
        value: function () {
          return [];
        },
        notify: true,
        observer: '_calculateOutput'
      },
      splitColumnNames: {
        type: Array,
        value: function () {
          return [];
        },
        notify: true,
        observer: '_calculateOutput'
      }
    },
    // Called when <lens-data-split> element is created.
    ready: function () {
    },
    // Change watcher for input attribute. Triggered whenever input is changed
    inputChanged: function () {
      var self = this;
      console.log('input changed data split');
      var firstItem = self.input[0];
      if (!firstItem) {
        return;
      }
      var attributes = Object.keys(firstItem);
      if (JSON.stringify(self._dataAttributes) === JSON.stringify(attributes)) {
      }  //self._mapChartData();
      else
        //self._mapChartData();
        {
          self._dataAttributes = attributes;
        }
      self._calculateOutput();
    },
    // Calculates output from input based on settings
    _calculateOutput: function () {
      var self = this;
      if (self.splitColumn && self.splitChar && self.splitChar.length > 0) {
        if (!self.input || !self.input.length) {
          return;
        }
        if (typeof self.input[0][self.splitColumn] === 'string') {
          //TODO: catch exception for split instead?
          self.output = self.input.map(function (item) {
            var splits = item[self.splitColumn].split(self.splitChar);
            if (self.splitColumnNames.length === 0 || self.splitColumnNames.length !== splits.length) {
              self._generateColumnNames(splits.length);
            }  //clone item
            //clone item
            var ret = {};
            var keys = Object.keys(item);
            keys.forEach(function (key) {
              ret[key] = item[key];
            });
            splits.forEach(function (split, index) {
              ret[self.splitColumnNames[index]] = splits[index].trim();
            });
            return ret;
          });

          self.fire('lens-output-changed', self.output);

        } else {
        }  //error
      }
    },
    //error
    // Creates defualt column names (split1, split2 etc.)
    _generateColumnNames: function (n) {
      for (var i = 0; i < n; i++) {
        if (!this.splitColumnNames[i]) {
          this.splitColumnNames[i] = 'split' + (i + 1);
        }
      }
      if (n < this.splitColumnNames.length) {
        this.splitColumnNames.splice(0, n);
      }
    },
    // Triggered when user changes the new column names
    _splitNameChanged: function (detail, e, selection) {
      var index = selection.getAttribute('index');
      this.splitColumnNames[index] = selection.value;  //TODO: map the output and rename column instead of going through the process again
      //TODO: map the output and rename column instead of going through the process again
      this._calculateOutput();
    }
  });
</script>
